<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranked Zone</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(180deg,#0f0f0f,#1a1a1a);color:#fff}
    .container{padding:16px;max-width:700px;margin:0 auto}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:50%;background:#111;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,122,0,.35)}
    .title{font-size:20px;font-weight:800;letter-spacing:.2px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#141414;border:1px solid rgba(255,255,255,.08)}
    .tabs{display:flex;gap:10px;margin:12px 0 16px}
    .tab{flex:1;text-align:center;padding:12px;border-radius:14px;background:#151515;border:1px solid rgba(255,255,255,.08);cursor:pointer;font-weight:700}
    .tab.active{background:rgba(255,122,0,.15);border:1px solid rgba(255,122,0,.35)}
    .card{background:#151515;padding:16px;border-radius:16px;margin-bottom:14px;border:1px solid rgba(255,255,255,.08)}
    .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .muted{opacity:.75}
    input{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:#0f0f0f;color:#fff}
    button{width:100%;padding:12px;border-radius:12px;border:none;font-weight:800;cursor:pointer;margin-top:10px}
    .primary{background:#ff7a00;color:#0b0b0b}
    .secondary{background:#2b2b2b;color:#fff}
    .danger{background:#3a1a1a;color:#fff}
    .ok{color:#45ff83}
    .warn{color:#ffb84d}
    .bad{color:#ff4d4d}
    .small{font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:12px;border-radius:14px;background:#101010;border:1px solid rgba(255,255,255,.08)}
    .actions{display:flex;gap:10px;margin-top:10px}
    .actions button{margin-top:0}
  </style>
</head>
<body>

<div class="container">
  <div class="top">
    <div class="brand">
      <div class="logo">RZ</div>
      <div>
        <div class="title">Ranked Zone</div>
        <div class="muted small">Mini App ‚Ä¢ –î—É—ç–ª–∏ ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥</div>
      </div>
    </div>
    <div class="pill" id="tgOk">Telegram: ...</div>
  </div>

  <div class="tabs">
    <div class="tab active" id="tabProfile" onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="tab" id="tabMM" onclick="showTab('mm')">–ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥</div>
    <div class="tab" id="tabAdmin" onclick="showTab('admin')" style="display:none">–ê–¥–º–∏–Ω</div>
  </div>

  <!-- PROFILE -->
  <div id="pageProfile">
    <div class="card">
      <div class="row">
        <div><b>Telegram ID</b><div class="muted" id="tgId">...</div></div>
        <div><b>–°—Ç–∞—Ç—É—Å</b><div id="verifyStatus" class="warn">–∑–∞–≥—Ä—É–∑–∫–∞...</div></div>
      </div>
      <div class="muted small" style="margin-top:10px" id="hintStatus"></div>
    </div>

    <div class="card">
      <b>–î–∞–Ω–Ω—ã–µ Standoff 2</b>
      <input id="standoffId" placeholder="–¶–∏—Ñ—Ä–æ–≤–æ–π Standoff ID" />
      <input id="standoffNick" placeholder="–ù–∏–∫" />
      <button class="primary" onclick="saveProfile()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
      <div class="muted small">–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–µ—Ç <b>pending</b>. –ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –≤—Ä—É—á–Ω—É—é.</div>
    </div>
  </div>

  <!-- MATCHMAKING -->
  <div id="pageMM" style="display:none">
    <div class="card">
      <b>–ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ (–¥—É—ç–ª–∏)</b>
      <div class="muted small" style="margin-top:6px">
        –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ <b>verified</b>. –í –æ—á–µ—Ä–µ–¥—å –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç.
      </div>
      <button class="secondary" onclick="findMatch()">–ù–∞–π—Ç–∏ –º–∞—Ç—á</button>
      <button class="secondary" onclick="leaveQueue()">–í—ã–π—Ç–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏</button>
      <div id="matchStatus" style="margin-top:10px;font-weight:800"></div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="pageAdmin" style="display:none">
    <div class="card">
      <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>
      <div class="muted small" style="margin-top:6px">–ó–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É (pending)</div>
      <button class="secondary" onclick="loadPending()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>

    <div class="card">
      <div class="list" id="pendingList">
        <div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  const ADMIN_TG_ID = 8001108991; // —Ç–≤–æ–π Telegram ID (–∞–¥–º–∏–Ω)

  const supabase = window.supabase.createClient(
    "https://wbjmvafzgwvspswchghx.supabase.co",
    "sb_publishable_IkbenyjJMOsjztywoz0KXg_WJ3lHKqm"
  );

  const user = tg.initDataUnsafe.user;
  const tgId = user?.id;

  document.getElementById("tgOk").innerText = tgId ? "Telegram: OK" : "Telegram: NO";
  document.getElementById("tgId").innerText = tgId || "–Ω–µ –ø–æ–ª—É—á–µ–Ω";

  if (tgId === ADMIN_TG_ID) {
    document.getElementById("tabAdmin").style.display = "block";
  }

  function showTab(name){
    document.getElementById("tabProfile").classList.remove("active");
    document.getElementById("tabMM").classList.remove("active");
    document.getElementById("tabAdmin").classList.remove("active");

    document.getElementById("pageProfile").style.display = "none";
    document.getElementById("pageMM").style.display = "none";
    document.getElementById("pageAdmin").style.display = "none";

    if(name==="profile"){ document.getElementById("tabProfile").classList.add("active"); document.getElementById("pageProfile").style.display="block";}
    if(name==="mm"){ document.getElementById("tabMM").classList.add("active"); document.getElementById("pageMM").style.display="block";}
    if(name==="admin"){ document.getElementById("tabAdmin").classList.add("active"); document.getElementById("pageAdmin").style.display="block"; loadPending(); }
  }

  async function initUser() {
    if (!tgId) return;

    let { data } = await supabase.from("users").select("*").eq("tg_id", tgId).single();

    if (!data) {
      await supabase.from("users").insert({
        tg_id: tgId,
        username: user?.username || null,
        first_name: user?.first_name || null
      });
      data = { verify_status: "none" };
    }

    updateUI(data);
  }

  function statusColor(status){
    if(status==="verified") return "ok";
    if(status==="pending") return "warn";
    if(status==="rejected") return "bad";
    return "warn";
  }

  function updateUI(data) {
    const s = data.verify_status || "none";
    const el = document.getElementById("verifyStatus");
    el.className = statusColor(s);
    el.innerText = s;

    const hint = document.getElementById("hintStatus");
    if (s === "none") hint.innerText = "–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –∏ –æ—Ç–ø—Ä–∞–≤—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.";
    if (s === "pending") hint.innerText = "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.";
    if (s === "verified") hint.innerText = "‚úÖ –¢—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω. –ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–µ–Ω.";
    if (s === "rejected") hint.innerText = "‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤—å —Å–Ω–æ–≤–∞.";

    if (data.standoff_id) document.getElementById("standoffId").value = data.standoff_id;
    if (data.standoff_nick) document.getElementById("standoffNick").value = data.standoff_nick;
  }

  async function saveProfile() {
    const standoffId = document.getElementById("standoffId").value.trim();
    const standoffNick = document.getElementById("standoffNick").value.trim();

    if (!standoffId || !standoffNick) {
      tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ Standoff ID –∏ –ù–∏–∫.");
      return;
    }

    await supabase.from("users").update({
      standoff_id: standoffId,
      standoff_nick: standoffNick,
      verify_status: "pending",
      updated_at: new Date().toISOString()
    }).eq("tg_id", tgId);

    tg.showAlert("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É");
    initUser();
  }

  async function findMatch() {
    const { data } = await supabase.from("users").select("verify_status, mmr").eq("tg_id", tgId).single();
    const out = document.getElementById("matchStatus");

    if (!data || data.verify_status !== "verified") {
      out.className = "bad";
      out.innerText = "–ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.";
      return;
    }

    // —Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ 5 –º–∏–Ω—É—Ç (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º created_at –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º)
    await supabase.from("queue").upsert({
      tg_id: tgId,
      mmr: data.mmr || 1000,
      maps: ["duel"],
      created_at: new Date().toISOString()
    });

    out.className = "ok";
    out.innerText = "‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å (5 –º–∏–Ω—É—Ç).";
  }

  async function leaveQueue(){
    const out = document.getElementById("matchStatus");
    await supabase.from("queue").delete().eq("tg_id", tgId);
    out.className = "warn";
    out.innerText = "–í—ã –≤—ã—à–ª–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏.";
  }

  // ADMIN
  async function loadPending(){
    if (tgId !== ADMIN_TG_ID) return;
    const list = document.getElementById("pendingList");
    list.innerHTML = "<div class='muted'>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>";

    const { data, error } = await supabase
      .from("users")
      .select("tg_id, username, first_name, standoff_id, standoff_nick, updated_at")
      .eq("verify_status", "pending")
      .order("updated_at", { ascending: false });

    if (error) {
      list.innerHTML = "<div class='bad'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>";
      return;
    }

    if (!data || data.length === 0) {
      list.innerHTML = "<div class='muted'>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ üü¢</div>";
      return;
    }

    list.innerHTML = "";
    data.forEach(u => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div><b>${u.standoff_nick || "‚Äî"}</b> <span class="muted small">(${u.standoff_id || "‚Äî"})</span></div>
        <div class="muted small">tg: ${u.tg_id} ‚Ä¢ @${u.username || "‚Äî"} ‚Ä¢ ${u.first_name || ""}</div>
        <div class="actions">
          <button class="primary" onclick="setVerified(${u.tg_id}, true)">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button class="danger" onclick="setVerified(${u.tg_id}, false)">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  async function setVerified(targetTgId, ok){
    if (tgId !== ADMIN_TG_ID) return;

    await supabase.from("users").update({
      verify_status: ok ? "verified" : "rejected",
      updated_at: new Date().toISOString()
    }).eq("tg_id", targetTgId);

    loadPending();
  }

  initUser();
</script>

</body>
</html>
