<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ranked Zone</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#070A10;
      --bg1:#0B1220;
      --card:#0E1A2B;
      --card2:#0B1626;
      --stroke:rgba(255,255,255,.08);
      --text:#EAF2FF;
      --muted:rgba(234,242,255,.65);
      --muted2:rgba(234,242,255,.45);

      --accent:#F5A623;
      --accent2:#FF7A18;
      --good:#2EE59D;
      --bad:#FF4D4D;

      --r:18px;
      --r2:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 15%, rgba(245,166,35,.13), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(255,122,24,.10), transparent 55%),
        radial-gradient(900px 900px at 40% 110%, rgba(0,160,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding: 18px 16px 24px;
    }

    .wrap{ max-width: 820px; margin: 0 auto; }

    .top{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom: 12px;
    }

    .logo{
      width:48px;height:48px;border-radius:16px;
      background:
        radial-gradient(16px 16px at 30% 25%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(245,166,35,.35), rgba(255,122,24,.18)),
        rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      display:grid;
      place-items:center;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      font-weight:900;
      letter-spacing:.5px;
    }

    .titleblock{ flex:1; min-width:0; }
    .title{ font-size: 22px; font-weight: 800; line-height: 1.1; }
    .subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(46,229,157,.15);
    }

    .tabs{ margin-top: 10px; display:flex; gap:10px; }
    .tabbtn{
      flex:1;
      padding:14px 14px;
      border-radius: var(--r2);
      background: rgba(255,255,255,.03);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-weight: 800;
      font-size: 16px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
      text-align:center;
    }
    .tabbtn.active{
      background:
        radial-gradient(500px 200px at 40% 0%, rgba(245,166,35,.20), transparent 60%),
        rgba(255,255,255,.05);
      color: var(--text);
      border-color: rgba(245,166,35,.28);
      box-shadow: 0 16px 50px rgba(0,0,0,.40);
    }

    .card{
      margin-top: 14px;
      border-radius: 26px;
      background:
        radial-gradient(800px 350px at 30% -10%, rgba(245,166,35,.12), transparent 60%),
        radial-gradient(700px 300px at 90% 10%, rgba(0,160,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding: 18px;
      overflow:hidden;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }

    .label{ font-size: 13px; color: var(--muted2); margin-bottom: 6px; }
    .value{ font-size: 22px; font-weight: 900; letter-spacing:.2px; }

    .status{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-weight: 800;
      color:var(--muted);
      white-space:nowrap;
    }
    .status .s-dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,77,77,.15);
    }
    .status.ok .s-dot{
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(46,229,157,.15);
    }

    .grid2{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .field{
      border-radius: 18px;
      padding: 14px 14px;
      background: rgba(0,0,0,.16);
      border:1px solid var(--stroke);
    }

    .sep{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }

    .btnrow{
      display:flex;
      gap:12px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    .btn{
      flex:1;
      min-width: 180px;
      padding: 14px 14px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
      text-align:center;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(245,166,35,.34);
      background:
        radial-gradient(500px 160px at 40% 0%, rgba(245,166,35,.28), transparent 65%),
        rgba(255,255,255,.05);
    }
    .btn.orange{
      background: linear-gradient(135deg, rgba(245,166,35,.95), rgba(255,122,24,.95));
      border-color: rgba(255,255,255,.10);
      color:#16110A;
      box-shadow: 0 18px 55px rgba(245,166,35,.22);
    }
    .btn.red{
      background: rgba(255,77,77,.14);
      border-color: rgba(255,77,77,.35);
    }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .adminBadge{
      display:none;
      margin-left:10px;
      font-size: 12px;
      font-weight: 900;
      color: #16110A;
      background: linear-gradient(135deg, rgba(245,166,35,.95), rgba(255,122,24,.95));
      padding: 6px 10px;
      border-radius: 999px;
      vertical-align: middle;
    }

    .adminBox{
      border-radius: 18px;
      padding: 14px;
      border:1px dashed rgba(245,166,35,.35);
      background: rgba(245,166,35,.06);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .small{ font-size: 12px; color: var(--muted2); }

    .req{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .reqTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .reqTitle{ font-weight: 900; }
    .reqMeta{ color: var(--muted2); font-size: 12px; margin-top: 4px; }
    .reqBtns{ display:flex; gap:10px; margin-top: 10px; flex-wrap:wrap; }
    .reqBtns .btn{ min-width: 0; flex:1; }

    /* DEBUG PANEL */
    #dbg{
      position:fixed;
      left:10px; right:10px; bottom:10px;
      background:#111; color:#fff;
      padding:10px;
      border-radius:12px;
      font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      z-index:999999;
      opacity:.95;
      border:1px solid rgba(255,255,255,.12);
      pointer-events:none;
      white-space:pre-wrap;
    }

    @media (max-width:520px){
      .grid2{ grid-template-columns: 1fr; }
      .btn{ min-width: 0; }
    }
  </style>
</head>
<body>

  <!-- DEBUG -->
  <div id="dbg">DBG: loading...</div>

  <div class="wrap">
    <div class="top">
      <div class="logo">RZ</div>
      <div class="titleblock">
        <div class="title">
          Ranked Zone
          <span id="adminBadge" class="adminBadge">АДМИН</span>
        </div>
        <div class="subtitle">Mini App • Дуэли • Рейтинг</div>
      </div>
      <div class="pill"><span class="dot"></span><span id="tgStatus">Telegram: OK</span></div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tabbtn active" data-tab="profile">Профиль</div>
      <div class="tabbtn" data-tab="mm">Матчмейкинг</div>
      <div class="tabbtn" data-tab="admin" id="adminTabBtn" style="display:none;">Админ</div>
    </div>

    <div class="card" id="card">
      <!-- PROFILE -->
      <div id="view-profile">
        <div class="row">
          <div>
            <div class="label">Telegram ID</div>
            <div class="value" id="tgIdText">не получен</div>
          </div>

          <div class="status" id="verifyPill">
            <span class="s-dot"></span>
            <span id="verifyText">Не проверен</span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">Standoff ID</div>
            <div class="value" id="soIdText">—</div>
          </div>
          <div class="field">
            <div class="label">Ник</div>
            <div class="value" id="nickText">—</div>
          </div>
        </div>

        <div class="btnrow">
          <div class="btn primary" id="btnFill">Заполнить профиль</div>
          <div class="btn" id="btnOpenBot">Открыть бота</div>
        </div>

        <div class="hint" id="profileHint">
          База подключена. Профиль и статусы берём из Supabase.
        </div>
      </div>

      <!-- MATCHMAKING -->
      <div id="view-mm" style="display:none;">
        <div class="row">
          <div>
            <div class="label">Дуэли (как в игре)</div>
            <div class="value">Поиск матча</div>
          </div>
          <div class="status" id="mmGate">
            <span class="s-dot"></span>
            <span id="mmGateText">Недоступен</span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="adminBox" id="mmBox">
          Чтобы искать матч, нужно пройти проверку в боте.
          <div class="small" style="margin-top:8px;">
            (Позже: выбор карт — 1 минимум, если не нашло — просим выбрать больше.)
          </div>
        </div>

        <div class="btnrow">
          <div class="btn orange" id="btnFindMatch">⚔️ Найти матч</div>
          <div class="btn" id="btnGoVerify">✅ Пройти проверку</div>
        </div>

        <div class="hint">
          Таймер матча: 15 минут. Ожидание подбора: до 5 минут.
        </div>
      </div>

      <!-- ADMIN -->
      <div id="view-admin" style="display:none;">
        <div class="row">
          <div>
            <div class="label">Админ-панель</div>
            <div class="value">Заявки</div>
          </div>
          <div class="pill"><span class="dot"></span><span>Доступ есть</span></div>
        </div>

        <div class="sep"></div>

        <div class="adminBox">
          Ниже — заявки со статусом <b>pending</b>. Нажми ✅ чтобы подтвердить или ❌ чтобы отклонить.
          <div class="small" style="margin-top:8px;">
            ⚠️ Для MVP работает прямо из мини-аппа. Потом сделаем безопасно через бота/бекенд.
          </div>
        </div>

        <div class="btnrow" style="margin-top:14px;">
          <div class="btn primary" id="btnAdminRefresh">Обновить заявки</div>
          <div class="btn" id="btnAdminPing">Проверить доступ</div>
        </div>

        <div class="hint" id="adminHint"></div>
        <div id="adminList"></div>
      </div>
    </div>
  </div>

  <script>
    // ======= STEP 1: JS живой =======
    alert("JS живой ✅");

    // ======= DEBUG HELPERS =======
    const dbgEl = document.getElementById("dbg");
    const dbg = (m)=>{ if(dbgEl) dbgEl.textContent = "DBG: " + m; console.log(m); };

    window.addEventListener("error", (e)=>{
      dbg("JS ERROR: " + (e.message || "unknown"));
    });
    window.addEventListener("unhandledrejection", (e)=>{
      dbg("PROMISE ERROR: " + (e.reason?.message || e.reason || "unknown"));
    });

    document.addEventListener("DOMContentLoaded", ()=>{
      dbg("DOM loaded ✅");
    });

    // =========================
    // SUPABASE CONFIG (ТУТ ПОМЕНЯЙ КЛЮЧ!)
    // =========================
    const SUPABASE_URL = "https://wbjmvafzgwvspswchghx.supabase.co";

    // ⚠️ НУЖЕН anon public key вида: eyJhbGciOiJIUzI1NiIsInR...
    // Supabase Dashboard → Settings → API → Project API keys → anon public
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiam12YWZ6Z3d2c3Bzd2NoZ2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMzA0NjcsImV4cCI6MjA4NzcwNjQ2N30.ax-_pe4r7PUZxDaZeW6z7tMuHtgsOhAxPx1_XqQW6X8 ";

    if(!window.supabase?.createClient){
      dbg("Supabase lib не загрузилась ❌");
    }

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // BOT LINK (вставь юзернейм бота)
    // =========================
    const BOT_LINK = "https://t.me/"; // например: "https://t.me/RankedZoneBot"

    // =========================
    // TELEGRAM INIT
    // =========================
    const tg = window.Telegram?.WebApp;
    try {
      tg?.ready();
      tg?.expand();
      tg?.setHeaderColor?.("#0B1220");
      tg?.setBackgroundColor?.("#070A10");
    } catch(e){}

    const tgUser = tg?.initDataUnsafe?.user || null;
    const tgId = tgUser?.id || null;

    // =========================
    // STATE (истина = база)
    // =========================
    const state = {
      tg_id: tgId,
      username: tgUser?.username || null,
      first_name: tgUser?.first_name || null,

      standoff_id: "",
      nick: "",
      verify_status: "none",
      role: "user"
    };

    // =========================
    // UI HELPERS
    // =========================
    const $ = (id)=>document.getElementById(id);

    function renderProfile(){
      $("tgIdText").textContent = state.tg_id ? String(state.tg_id) : "не получен";
      $("soIdText").textContent = state.standoff_id ? state.standoff_id : "—";
      $("nickText").textContent = state.nick ? state.nick : "—";

      const pill = $("verifyPill");
      const dot = pill.querySelector(".s-dot");
      const text = $("verifyText");

      pill.classList.remove("ok");
      dot.style.background = "var(--bad)";
      dot.style.boxShadow = "0 0 0 4px rgba(255,77,77,.15)";
      text.textContent = "Не проверен";

      if(state.verify_status === "pending"){
        text.textContent = "На проверке";
        dot.style.background = "var(--accent)";
        dot.style.boxShadow = "0 0 0 4px rgba(245,166,35,.15)";
      }
      if(state.verify_status === "verified"){
        text.textContent = "Проверен";
        pill.classList.add("ok");
      }
      if(state.verify_status === "rejected"){
        text.textContent = "Отклонён";
      }
    }

    function renderMatchmaking(){
      const gate = $("mmGate");
      const gateText = $("mmGateText");

      gate.classList.remove("ok");
      gateText.textContent = "Недоступен";
      gate.querySelector(".s-dot").style.background = "var(--bad)";

      if(state.verify_status === "verified"){
        gate.classList.add("ok");
        gateText.textContent = "Доступен";
      }
    }

    function isAdmin(){ return state.role === "admin"; }

    function renderAdmin(){
      const show = isAdmin();
      $("adminTabBtn").style.display = show ? "" : "none";
      $("adminBadge").style.display = show ? "inline-flex" : "none";
      $("adminHint").textContent = show ? `Ты админ. TG ID: ${state.tg_id}` : "Админ-доступа нет.";
      if(!show) $("adminList").innerHTML = "";
    }

    function switchTab(tab){
      document.querySelectorAll(".tabbtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === tab);
      });
      $("view-profile").style.display = (tab==="profile") ? "" : "none";
      $("view-mm").style.display = (tab==="mm") ? "" : "none";
      $("view-admin").style.display = (tab==="admin") ? "" : "none";
    }

    // =========================
    // DB FUNCTIONS
    // =========================
    async function ensureUserRow(){
      if(!state.tg_id) return;

      dbg("ensureUserRow...");

      const payload = {
        tg_id: Number(state.tg_id),
        username: state.username,
        first_name: state.first_name,
        verify_status: "none",
        role: "user"
      };

      const { error } = await supabase
        .from("users")
        .upsert(payload, { onConflict: "tg_id" });

      if(error){
        dbg("ensureUserRow error: " + error.message);
        $("profileHint").textContent = "Ошибка базы: " + error.message;
      } else {
        dbg("ensureUserRow OK ✅");
      }
    }

    async function loadMeFromDB(){
      if(!state.tg_id) return;

      dbg("loadMeFromDB...");

      const { data, error } = await supabase
        .from("users")
        .select("tg_id, username, first_name, standoff_id, standoff_nick, verify_status, role")
        .eq("tg_id", Number(state.tg_id))
        .maybeSingle();

      if(error){
        dbg("loadMeFromDB error: " + error.message);
        $("profileHint").textContent = "Ошибка загрузки из базы: " + error.message;
        return;
      }

      if(data){
        state.standoff_id = data.standoff_id || "";
        state.nick = data.standoff_nick || "";
        state.verify_status = data.verify_status || "none";
        state.role = data.role || "user";
      }

      renderProfile();
      renderMatchmaking();
      renderAdmin();
      $("profileHint").textContent = "Профиль загружен из Supabase ✅";
      dbg("loadMeFromDB OK ✅");
    }

    // =========================
    // EVENTS
    // =========================
    $("tabs").addEventListener("click", (e)=>{
      const btn = e.target.closest(".tabbtn");
      if(!btn) return;
      const tab = btn.dataset.tab;
      if(tab === "admin" && !isAdmin()) return;
      switchTab(tab);
    });

    $("btnOpenBot").addEventListener("click", ()=>{
      if(BOT_LINK && BOT_LINK !== "https://t.me/"){
        window.open(BOT_LINK, "_blank");
      } else {
        alert("Вставь ссылку на бота в BOT_LINK в коде.");
      }
    });

    $("btnFill").addEventListener("click", ()=>{
      alert("Кнопка живая ✅ (потом вернем сохранение)");
    });

    $("btnGoVerify").addEventListener("click", ()=>{
      alert("Кнопка живая ✅");
    });

    $("btnFindMatch").addEventListener("click", ()=>{
      alert("Кнопка живая ✅");
    });

    $("btnAdminRefresh").addEventListener("click", ()=>{
      alert("Кнопка живая ✅");
    });

    $("btnAdminPing").addEventListener("click", ()=>{
      alert(isAdmin() ? "Админ доступ: ОК" : "Ты не админ");
    });

    // =========================
    // INIT
    // =========================
    $("tgStatus").textContent = tg ? "Telegram: OK" : "Telegram: OFF";

    if(!state.tg_id){
      $("tgIdText").textContent = "не получен";
      $("profileHint").textContent = "Telegram ID не пришёл. Открой мини-апп из бота.";
      dbg("TG ID = null (не WebApp режим?)");
    }

    renderProfile();
    renderMatchmaking();
    renderAdmin();
    switchTab("profile");

    (async ()=>{
      await ensureUserRow();
      await loadMeFromDB();
    })();
  </script>
</body>
</html>
