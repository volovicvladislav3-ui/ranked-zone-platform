<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ranked Zone</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#070A10;
      --bg1:#0B1220;
      --stroke:rgba(255,255,255,.08);
      --text:#EAF2FF;
      --muted:rgba(234,242,255,.65);
      --muted2:rgba(234,242,255,.45);

      --accent:#F5A623;
      --accent2:#FF7A18;
      --good:#2EE59D;
      --bad:#FF4D4D;

      --r2:22px;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 15%, rgba(245,166,35,.13), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(255,122,24,.10), transparent 55%),
        radial-gradient(900px 900px at 40% 110%, rgba(0,160,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding: 18px 16px 24px;
      touch-action: manipulation;
    }

    .wrap{ max-width: 820px; margin: 0 auto; }

    .top{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom: 12px;
    }

    .logo{
      width:48px;height:48px;border-radius:16px;
      background:
        radial-gradient(16px 16px at 30% 25%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(245,166,35,.35), rgba(255,122,24,.18)),
        rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      display:grid;
      place-items:center;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      font-weight:900;
      letter-spacing:.5px;
      user-select:none;
    }

    .titleblock{ flex:1; min-width:0; }
    .title{ font-size: 22px; font-weight: 800; line-height: 1.1; }
    .subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(46,229,157,.15);
    }

    .tabs{
      margin-top: 10px;
      display:flex;
      gap:10px;
    }
    .tabbtn{
      flex:1;
      padding:14px 14px;
      border-radius: var(--r2);
      background: rgba(255,255,255,.03);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-weight: 800;
      font-size: 16px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      -webkit-tap-highlight-color: transparent;
    }
    .tabbtn.active{
      background:
        radial-gradient(500px 200px at 40% 0%, rgba(245,166,35,.20), transparent 60%),
        rgba(255,255,255,.05);
      color: var(--text);
      border-color: rgba(245,166,35,.28);
      box-shadow: 0 16px 50px rgba(0,0,0,.40);
    }

    .card{
      margin-top: 14px;
      border-radius: 26px;
      background:
        radial-gradient(800px 350px at 30% -10%, rgba(245,166,35,.12), transparent 60%),
        radial-gradient(700px 300px at 90% 10%, rgba(0,160,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding: 18px;
      overflow:hidden;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }

    .label{ font-size: 13px; color: var(--muted2); margin-bottom: 6px; }
    .value{ font-size: 22px; font-weight: 900; letter-spacing:.2px; }

    .status{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-weight: 800;
      color:var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .status .s-dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,77,77,.15);
    }
    .status.ok .s-dot{
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(46,229,157,.15);
    }

    .grid2{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .field{
      border-radius: 18px;
      padding: 14px 14px;
      background: rgba(0,0,0,.16);
      border:1px solid var(--stroke);
    }

    .sep{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }

    .btnrow{
      display:flex;
      gap:12px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    .btn{
      flex:1;
      min-width: 180px;
      padding: 14px 14px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      text-align:center;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      border-color: rgba(245,166,35,.34);
      background:
        radial-gradient(500px 160px at 40% 0%, rgba(245,166,35,.28), transparent 65%),
        rgba(255,255,255,.05);
    }
    .btn.orange{
      background: linear-gradient(135deg, rgba(245,166,35,.95), rgba(255,122,24,.95));
      border-color: rgba(255,255,255,.10);
      color:#16110A;
      box-shadow: 0 18px 55px rgba(245,166,35,.22);
    }
    .btn.red{
      background: rgba(255,77,77,.14);
      border-color: rgba(255,77,77,.35);
    }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      word-break: break-word;
    }

    .adminBadge{
      display:none;
      margin-left:10px;
      font-size: 12px;
      font-weight: 900;
      color: #16110A;
      background: linear-gradient(135deg, rgba(245,166,35,.95), rgba(255,122,24,.95));
      padding: 6px 10px;
      border-radius: 999px;
      vertical-align: middle;
    }

    .adminBox{
      border-radius: 18px;
      padding: 14px;
      border:1px dashed rgba(245,166,35,.35);
      background: rgba(245,166,35,.06);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .small{ font-size: 12px; color: var(--muted2); }

    .req{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .reqTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .reqTitle{ font-weight: 900; }
    .reqMeta{ color: var(--muted2); font-size: 12px; margin-top: 4px; }
    .reqBtns{ display:flex; gap:10px; margin-top: 10px; flex-wrap:wrap; }
    .reqBtns .btn{ min-width: 0; flex:1; }

    .dbg{
      position: fixed;
      left: 12px; right: 12px; bottom: 10px;
      z-index: 9999;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(0,0,0,.60);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
      font-size: 12px;
      backdrop-filter: blur(8px);
      pointer-events: none; /* –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ */
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    @media (max-width:520px){
      .grid2{ grid-template-columns: 1fr; }
      .btn{ min-width: 0; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">RZ</div>
      <div class="titleblock">
        <div class="title">
          Ranked Zone
          <span id="adminBadge" class="adminBadge">–ê–î–ú–ò–ù</span>
        </div>
        <div class="subtitle">Mini App ‚Ä¢ –î—É—ç–ª–∏ ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥</div>
      </div>
      <div class="pill"><span class="dot"></span><span id="tgStatus">Telegram: ...</span></div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tabbtn active" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="tabbtn" data-tab="mm">–ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥</div>
      <div class="tabbtn" data-tab="admin" id="adminTabBtn" style="display:none;">–ê–¥–º–∏–Ω</div>
    </div>

    <div class="card">
      <!-- PROFILE -->
      <div id="view-profile">
        <div class="row">
          <div>
            <div class="label">Telegram ID</div>
            <div class="value" id="tgIdText">–Ω–µ –ø–æ–ª—É—á–µ–Ω</div>
          </div>

          <div class="status" id="verifyPill">
            <span class="s-dot"></span>
            <span id="verifyText">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω</span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">Standoff ID</div>
            <div class="value" id="soIdText">‚Äî</div>
          </div>
          <div class="field">
            <div class="label">–ù–∏–∫</div>
            <div class="value" id="nickText">‚Äî</div>
          </div>
        </div>

        <div class="btnrow">
          <div class="btn primary" id="btnFill">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
          <div class="btn" id="btnOpenBot">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</div>
        </div>

        <div class="hint" id="profileHint">–ë–∞–∑–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞. –ü—Ä–æ—Ñ–∏–ª—å –∏ —Å—Ç–∞—Ç—É—Å—ã –±–µ—Ä—ë–º –∏–∑ Supabase.</div>
      </div>

      <!-- MATCHMAKING -->
      <div id="view-mm" style="display:none;">
        <div class="row">
          <div>
            <div class="label">–î—É—ç–ª–∏ (–∫–∞–∫ –≤ –∏–≥—Ä–µ)</div>
            <div class="value">–ü–æ–∏—Å–∫ –º–∞—Ç—á–∞</div>
          </div>
          <div class="status" id="mmGate">
            <span class="s-dot"></span>
            <span id="mmGateText">–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="adminBox" id="mmBox">
          –ß—Ç–æ–±—ã –∏—Å–∫–∞—Ç—å –º–∞—Ç—á, –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –±–æ—Ç–µ.
          <div class="small" style="margin-top:8px;">
            (–ü–æ–∑–∂–µ: –≤—ã–±–æ—Ä –∫–∞—Ä—Ç ‚Äî 1 –º–∏–Ω–∏–º—É–º, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–æ ‚Äî –ø—Ä–æ—Å–∏–º –≤—ã–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ.)
          </div>
        </div>

        <div class="btnrow">
          <div class="btn orange" id="btnFindMatch">‚öîÔ∏è –ù–∞–π—Ç–∏ –º–∞—Ç—á</div>
          <div class="btn" id="btnGoVerify">‚úÖ –ü—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É</div>
        </div>

        <div class="hint">
          –¢–∞–π–º–µ—Ä –º–∞—Ç—á–∞: 15 –º–∏–Ω—É—Ç. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∞: –¥–æ 5 –º–∏–Ω—É—Ç.
        </div>
      </div>

      <!-- ADMIN -->
      <div id="view-admin" style="display:none;">
        <div class="row">
          <div>
            <div class="label">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <div class="value">–ó–∞—è–≤–∫–∏</div>
          </div>
          <div class="pill"><span class="dot"></span><span>–î–æ—Å—Ç—É–ø –µ—Å—Ç—å</span></div>
        </div>

        <div class="sep"></div>

        <div class="adminBox">
          –ù–∏–∂–µ ‚Äî –∑–∞—è–≤–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º <b>pending</b>. –ù–∞–∂–º–∏ ‚úÖ —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–ª–∏ ‚ùå —á—Ç–æ–±—ã –æ—Ç–∫–ª–æ–Ω–∏—Ç—å.
          <div class="small" style="margin-top:8px;">
            ‚ö†Ô∏è –î–ª—è MVP —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ –∏–∑ –º–∏–Ω–∏-–∞–ø–ø–∞. –ü–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞/–±–µ–∫–µ–Ω–¥.
          </div>
        </div>

        <div class="btnrow" style="margin-top:14px;">
          <div class="btn primary" id="btnAdminRefresh">–û–±–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–∫–∏</div>
          <div class="btn" id="btnAdminPing">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø</div>
        </div>

        <div class="hint" id="adminHint"></div>
        <div id="adminList"></div>
      </div>
    </div>
  </div>

  <div id="dbg" class="dbg">DBG: boot‚Ä¶</div>

  <script>
    // =========================
    // CONFIG (—Ç–≤–æ–∏)
    // =========================
    const SUPABASE_URL = "https://wbjmvafzgwvspswchghx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_IkbenyjJMOsjztywoz0KXg_WJ3lHKqm";
    const BOT_LINK = "https://t.me/rankedzone_off_bot";
    const MY_ADMIN_TG_ID = 8001108991; // –ø—Ä–æ—Å—Ç–æ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫, —Ä–æ–ª—å –±–µ—Ä—ë–º –∏–∑ –ë–î

    // =========================
    // DEBUG
    // =========================
    const dbgEl = document.getElementById("dbg");
    function dbg(msg){ dbgEl.textContent = "DBG: " + msg; console.log("[DBG]", msg); }
    window.addEventListener("error", (e)=>dbg("JS error: " + (e.message||"")));
    window.addEventListener("unhandledrejection", (e)=>dbg("Promise err: " + (e.reason?.message || String(e.reason)) ));

    // =========================
    // SUPABASE INIT
    // =========================
    if(!window.supabase?.createClient){
      dbg("Supabase lib –ù–ï –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å");
      document.getElementById("profileHint").textContent = "Supabase lib –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (CDN).";
    }
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // TELEGRAM INIT
    // =========================
    const tg = window.Telegram?.WebApp;
    try {
      tg?.ready();
      tg?.expand();
      tg?.setHeaderColor?.("#0B1220");
      tg?.setBackgroundColor?.("#070A10");
    } catch(e){}

    const tgUser = tg?.initDataUnsafe?.user || null;
    const tgId = tgUser?.id || null;

    document.getElementById("tgStatus").textContent = tg ? "Telegram: OK" : "Telegram: OFF";

    // =========================
    // STATE (–∏—Å—Ç–∏–Ω–∞ = –±–∞–∑–∞)
    // =========================
    const state = {
      tg_id: tgId,
      username: tgUser?.username || null,
      first_name: tgUser?.first_name || null,
      standoff_id: "",
      nick: "",
      verify_status: "none",
      role: "user"
    };

    // =========================
    // UI HELPERS
    // =========================
    const $ = (id)=>document.getElementById(id);

    function renderProfile(){
      $("tgIdText").textContent = state.tg_id ? String(state.tg_id) : "–Ω–µ –ø–æ–ª—É—á–µ–Ω";
      $("soIdText").textContent = state.standoff_id ? state.standoff_id : "‚Äî";
      $("nickText").textContent = state.nick ? state.nick : "‚Äî";

      const pill = $("verifyPill");
      const dot = pill.querySelector(".s-dot");
      const text = $("verifyText");

      pill.classList.remove("ok");
      dot.style.background = "var(--bad)";
      dot.style.boxShadow = "0 0 0 4px rgba(255,77,77,.15)";
      text.textContent = "–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω";

      if(state.verify_status === "pending"){
        text.textContent = "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ";
        dot.style.background = "var(--accent)";
        dot.style.boxShadow = "0 0 0 4px rgba(245,166,35,.15)";
      }
      if(state.verify_status === "verified"){
        text.textContent = "–ü—Ä–æ–≤–µ—Ä–µ–Ω";
        pill.classList.add("ok");
      }
      if(state.verify_status === "rejected"){
        text.textContent = "–û—Ç–∫–ª–æ–Ω—ë–Ω";
      }
    }

    function renderMatchmaking(){
      const gate = $("mmGate");
      const gateText = $("mmGateText");

      gate.classList.remove("ok");
      gateText.textContent = "–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
      gate.querySelector(".s-dot").style.background = "var(--bad)";

      if(state.verify_status === "verified"){
        gate.classList.add("ok");
        gateText.textContent = "–î–æ—Å—Ç—É–ø–µ–Ω";
      }
    }

    function isAdmin(){ return state.role === "admin"; }

    function renderAdmin(){
      const show = isAdmin();
      $("adminTabBtn").style.display = show ? "" : "none";
      $("adminBadge").style.display = show ? "inline-flex" : "none";
      $("adminHint").textContent = show
        ? `–¢—ã –∞–¥–º–∏–Ω. TG ID: ${state.tg_id}`
        : `–ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø–∞ –Ω–µ—Ç. (–ï—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω, –ø—Ä–æ–≤–µ—Ä—å users.role='admin' –¥–ª—è tg_id=${MY_ADMIN_TG_ID})`;
      if(!show) $("adminList").innerHTML = "";
    }

    function switchTab(tab){
      document.querySelectorAll(".tabbtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === tab);
      });
      $("view-profile").style.display = (tab==="profile") ? "" : "none";
      $("view-mm").style.display = (tab==="mm") ? "" : "none";
      $("view-admin").style.display = (tab==="admin") ? "" : "none";
    }

    function onTap(id, fn){
      const el = $(id);
      el.addEventListener("pointerup", (e)=>{ e.preventDefault(); fn(); }, {passive:false});
    }

    // =========================
    // DB FUNCTIONS
    // =========================
    async function ensureUserRow(){
      if(!state.tg_id) return;

      // –í–∞–∂–Ω–æ: –ù–ï –∑–∞—Ç–∏—Ä–∞–µ–º —Ä–æ–ª—å/—Å—Ç–∞—Ç—É—Å—ã —á—É–∂–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
      // Upsert –≤—Å—Ç–∞–≤–∏—Ç —Å—Ç—Ä–æ–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç, –Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –º—ã –ø–µ—Ä–µ–¥–∞–ª–∏.
      const payload = {
        tg_id: Number(state.tg_id),
        username: state.username,
        first_name: state.first_name
      };

      const { error } = await supabase
        .from("users")
        .upsert(payload, { onConflict: "tg_id" });

      if(error){
        dbg("ensureUserRow err: " + error.message);
        $("profileHint").textContent = "–û—à–∏–±–∫–∞ –±–∞–∑—ã: " + error.message;
      } else {
        dbg("ensureUserRow OK");
      }
    }

    async function loadMeFromDB(){
      if(!state.tg_id) return;

      const { data, error } = await supabase
        .from("users")
        .select("tg_id, username, first_name, standoff_id, standoff_nick, verify_status, role")
        .eq("tg_id", Number(state.tg_id))
        .maybeSingle();

      if(error){
        dbg("loadMe err: " + error.message);
        $("profileHint").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –±–∞–∑—ã: " + error.message;
        return;
      }

      if(data){
        state.standoff_id = data.standoff_id || "";
        state.nick = data.standoff_nick || "";
        state.verify_status = data.verify_status || "none";
        state.role = data.role || "user";
      }

      renderProfile();
      renderMatchmaking();
      renderAdmin();

      $("profileHint").textContent = "–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ Supabase ‚úÖ";
      dbg("loadMe OK role=" + state.role + " verify=" + state.verify_status);
    }

    async function saveProfileToDB(soId, nick){
      if(!state.tg_id) return { ok:false, msg:"Telegram ID –Ω–µ –ø–æ–ª—É—á–µ–Ω" };

      const nextStatus = (state.verify_status === "none" ? "pending" : state.verify_status);

      const { error } = await supabase
        .from("users")
        .update({
          standoff_id: soId,
          standoff_nick: nick,
          verify_status: nextStatus
        })
        .eq("tg_id", Number(state.tg_id));

      if(error) return { ok:false, msg:error.message };

      state.standoff_id = soId;
      state.nick = nick;
      state.verify_status = nextStatus;
      return { ok:true };
    }

    async function loadPendingRequests(){
      if(!isAdmin()){
        $("adminList").innerHTML = "";
        return;
      }

      $("adminList").innerHTML = `<div class="hint">–ó–∞–≥—Ä—É–∂–∞—é –∑–∞—è–≤–∫–∏...</div>`;

      const { data, error } = await supabase
        .from("users")
        .select("tg_id, username, first_name, standoff_id, standoff_nick, verify_status, created_at")
        .eq("verify_status", "pending")
        .order("created_at", { ascending: false })
        .limit(50);

      if(error){
        $("adminList").innerHTML = `<div class="hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: ${error.message}</div>`;
        return;
      }

      if(!data || data.length === 0){
        $("adminList").innerHTML = `<div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ üü¢</div>`;
        return;
      }

      const html = data.map(u => {
        const name = (u.standoff_nick || u.username || u.first_name || "–±–µ–∑ –∏–º–µ–Ω–∏");
        const so = u.standoff_id ? `Standoff ID: <b>${u.standoff_id}</b>` : "Standoff ID: ‚Äî";
        return `
          <div class="req" data-tgid="${u.tg_id}">
            <div class="reqTop">
              <div>
                <div class="reqTitle">${name}</div>
                <div class="reqMeta">TG: ${u.tg_id} ‚Ä¢ ${so}</div>
              </div>
              <div class="pill"><span class="dot"></span><span>pending</span></div>
            </div>
            <div class="reqBtns">
              <div class="btn orange" data-act="approve">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</div>
              <div class="btn red" data-act="reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</div>
            </div>
          </div>
        `;
      }).join("");

      $("adminList").innerHTML = html;
    }

    async function setVerifyStatus(targetTgId, status){
      if(!isAdmin()) return;

      const { error } = await supabase
        .from("users")
        .update({ verify_status: status })
        .eq("tg_id", Number(targetTgId));

      if(error){
        alert("–û—à–∏–±–∫–∞: " + error.message);
        return;
      }

      if(Number(targetTgId) === Number(state.tg_id)){
        state.verify_status = status;
        renderProfile();
        renderMatchmaking();
      }

      await loadPendingRequests();
    }

    // =========================
    // EVENTS
    // =========================
    $("tabs").addEventListener("pointerup", (e)=>{
      const btn = e.target.closest(".tabbtn");
      if(!btn) return;
      e.preventDefault();
      const tab = btn.dataset.tab;
      if(tab === "admin" && !isAdmin()) return;
      switchTab(tab);
    }, {passive:false});

    onTap("btnOpenBot", ()=>window.open(BOT_LINK, "_blank"));

    onTap("btnFill", async ()=>{
      const so = prompt("Standoff ID (—Ü–∏—Ñ—Ä–æ–≤–æ–π):", state.standoff_id || "");
      if(so === null) return;
      const nk = prompt("–ù–∏–∫:", state.nick || "");
      if(nk === null) return;

      const soId = (so || "").trim();
      const nick = (nk || "").trim();

      if(!soId || !nick){
        alert("–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∏ Standoff ID, –∏ –ù–∏–∫.");
        return;
      }

      const res = await saveProfileToDB(soId, nick);
      if(!res.ok){
        alert("–ù–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –≤ –±–∞–∑—É: " + res.msg);
        return;
      }

      renderProfile();
      renderMatchmaking();
      alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ –ó–∞—è–≤–∫–∞: " + (state.verify_status === "pending" ? "–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ" : state.verify_status));
    });

    onTap("btnGoVerify", ()=>alert("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞: –Ω–∞–∂–º–∏ ‚úÖ –ü—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ —á–∞—Ç–µ –±–æ—Ç–∞."));

    onTap("btnFindMatch", ()=>{
      if(state.verify_status !== "verified"){
        alert("–ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏ –ø—Ä–æ–≤–µ—Ä–∫—É.");
        return;
      }
      alert("–ü–æ–∏—Å–∫ –º–∞—Ç—á–∞ (MVP). –î–∞–ª—å—à–µ –ø–æ–¥–∫–ª—é—á–∏–º –æ—á–µ—Ä–µ–¥—å –≤ –±–∞–∑–µ –∏ –ø–æ–¥–±–æ—Ä.");
    });

    onTap("btnAdminRefresh", async ()=>{ await loadPendingRequests(); });
    onTap("btnAdminPing", ()=>alert(isAdmin() ? "–ê–¥–º–∏–Ω –¥–æ—Å—Ç—É–ø: –û–ö" : "–¢—ã –Ω–µ –∞–¥–º–∏–Ω"));

    $("adminList").addEventListener("pointerup", async (e)=>{
      const actBtn = e.target.closest("[data-act]");
      if(!actBtn) return;
      const req = e.target.closest(".req");
      if(!req) return;
      e.preventDefault();

      const target = req.getAttribute("data-tgid");
      const act = actBtn.getAttribute("data-act");

      if(act === "approve") await setVerifyStatus(target, "verified");
      if(act === "reject") await setVerifyStatus(target, "rejected");
    }, {passive:false});

    // =========================
    // INIT
    // =========================
    dbg("boot‚Ä¶ tg=" + !!tg + " sb=" + !!window.supabase);

    if(!state.tg_id){
      $("tgIdText").textContent = "–Ω–µ –ø–æ–ª—É—á–µ–Ω";
      $("profileHint").textContent = "Telegram ID –Ω–µ –ø—Ä–∏—à—ë–ª. –û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø –∏–∑ –±–æ—Ç–∞ (–Ω–µ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞).";
      dbg("NO TG ID (browser mode)");
      renderProfile();
      renderMatchmaking();
      renderAdmin();
      switchTab("profile");
    } else {
      (async ()=>{
        await ensureUserRow();
        await loadMeFromDB();
        if(isAdmin()) await loadPendingRequests();
        switchTab("profile");
        dbg("ready ‚úÖ");
      })();
    }
  </script>
</body>
</html>
